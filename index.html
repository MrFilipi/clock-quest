<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ClockQuest ‚Äî Learn to read analog time</title>
<meta name="color-scheme" content="light only">
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{
    /* Maple Bear vibe */
    --bg:#ffffff; --panel:#f6f6f6; --ink:#111111;
    --red:#c1121f; --good:#1f7a3f; --bad:#cc2936; --muted:#6b6f76; --shadow:0 10px 30px rgba(0,0,0,.10);
    /* Tamanho do rel√≥gio ‚ÄúO‚Äù (ajuste aqui) */
    --o-scale: 1.6;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
  a{color:var(--red)}
  .wrap{max-width:1024px;margin:auto;padding:16px}
  .card{background:var(--panel);border:2px solid #11111120;border-radius:14px;padding:16px;box-shadow:var(--shadow)}
  .controls,.status{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .pill{padding:8px 12px;border-radius:999px;border:2px solid #11111125;background:#fff}
  button{border:2px solid #111111;background:#fff;color:var(--ink);padding:10px 14px;border-radius:12px;font-weight:700}
  button:hover{transform:translateY(-1px)}
  button.primary{background:var(--red);color:#fff;border-color:#000}
  button.good{background:var(--good);color:#fff;border-color:#000}
  button.bad{background:var(--bad);color:#fff;border-color:#000}
  select,input[type=text]{border:2px solid #11111150;background:#fff;color:var(--ink);padding:10px 12px;border-radius:10px}
  .badge{border:2px solid #11111190;padding:6px 10px;border-radius:10px;background:#fff}
  .progress{height:10px;background:#fff;border:2px solid #11111150;border-radius:8px;overflow:hidden}
  .progress>span{display:block;height:100%;background:var(--red);width:0%}
  header{padding:16px;border-bottom:3px solid #000;background:#fff;position:sticky;top:0;z-index:2}
  header .brand{font-weight:900;letter-spacing:.5px}
  main{padding:16px}
  footer{padding:24px;border-top:3px solid #000;text-align:center;color:var(--muted)}

  /* ===== Intro ===== */
  .intro{display:grid;place-items:center;min-height:70svh}
  .title{display:flex;align-items:center;gap:10px;user-select:none}
  .title .word{font-weight:900;line-height:1;font-size:clamp(28px, 7vw, 72px);letter-spacing:1px;text-transform:uppercase}
  .title .pixel{font-family:"Press Start 2P", system-ui, sans-serif; letter-spacing:2px}
  .clockO-img{
    position: relative;
    width: calc(1em * var(--o-scale));
    height: calc(1em * var(--o-scale));
    display: inline-block;
    vertical-align: middle;
    image-rendering: pixelated;
  }
  .clockO-img img{
    width: 100%; height: 100%; display: block;
    border: 4px solid #000; border-radius: 50%; background:#fff;
    box-shadow: 4px 4px 0 #0001;
  }
  .clockO-img .hand{
    position:absolute; left:50%; top:50%;
    transform-origin: 50% calc(100% - 8px);
    background:#000; border-radius: 2px;
  }
  .clockO-img .hand.hour   { width:6px; height:35%; transform:translate(-50%,-100%) rotate(0deg); }
  .clockO-img .hand.minute { width:4px; height:44%; transform:translate(-50%,-100%) rotate(0deg); background:#c1121f; }
  .clockO-img .hand.second { width:2px; height:48%; transform:translate(-50%,-100%) rotate(0deg); background:#c1121f; opacity:.9 }

  .subtitle{margin-top:8px;color:#333}
  .intro-panel{display:grid;gap:14px;margin-top:18px}
  .mode-grid{display:grid;gap:10px;grid-template-columns:repeat(3,minmax(0,1fr))}
  @media (max-width:700px){.mode-grid{grid-template-columns:1fr}}
  .name-row{display:flex;gap:8px;flex-wrap:wrap}
  .name-row input{min-width:240px}

  /* ===== Game ===== */
  .grid{display:grid;gap:16px;grid-template-columns:1.3fr .9fr}
  @media (max-width:1000px){.grid{grid-template-columns:1fr}}
  canvas.clock{width:100%;height:auto;aspect-ratio:1/1;background:#fff;border-radius:50%;border:3px solid #000}

  .answer-zone{border:3px solid #000;border-radius:14px;padding:16px;background:#fff;position:relative;box-shadow:var(--shadow);animation:az 2.5s ease-in-out infinite}
  .answer-zone.stop{animation:none}
  @keyframes az{0%,100%{box-shadow:0 0 0 rgba(193,18,31,0)}50%{box-shadow:0 0 0 10px rgba(193,18,31,.08)}}
  #prompt{font-weight:900;margin:0 0 8px;font-size:1.1rem}

  .mc-grid{display:grid;gap:10px;grid-template-columns:repeat(3,1fr)}
  @media (max-width:700px){.mc-grid{grid-template-columns:1fr}}
  .choice{display:flex;align-items:center;gap:10px;border:3px solid #000;background:#fff;padding:14px 12px;border-radius:12px;font-weight:800;min-height:56px}
  .choice:hover,.choice:focus{outline:0;transform:translateY(-1px);box-shadow:0 6px 0 #000}
  .choice .badge-letter{width:34px;height:34px;border-radius:8px;display:grid;place-items:center;background:var(--red);color:#fff;border:2px solid #000}
  .choice.correct{background:#dff5e7;border-color:#000}
  .choice.wrong{background:#ffe3e6;border-color:#000}

  #typing input{width:100%;max-width:520px}
  .overlay{position:fixed;inset:0;background:rgba(255,255,255,.9);display:none;place-items:center;z-index:5}
  .overlay.show{display:grid}
  .count{font-size:clamp(48px,10vw,120px);font-weight:900;color:#000}
  .chip{background:#fff;border:3px solid #000;padding:4px 10px;border-radius:10px;font-weight:800}
</style>
</head>
<body>
<header>
  <div class="wrap" style="display:flex;align-items:center;justify-content:space-between;gap:12px">
    <div class="brand">üß≠ ClockQuest</div>
    <div id="playerBadge" class="chip" hidden></div>
  </div>
</header>

<main class="wrap">
  <!-- ===== INTRO PAGE ===== -->
  <section id="intro" class="intro">
    <div class="card" style="padding:24px; max-width:860px">
      <div class="title">
        <div class="word pixel">CL</div>

        <!-- O em IMAGEM com ponteiros -->
        <div class="clockO-img" id="logoO" aria-label="Clock O">
          <img id="logoOImg" src="assets/assets/pixel-art-of-a-modern-clock-with-arrows-marking-the-time-free-png.png" alt="Pixel clock"
               onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,<?xml version=&quot;1.0&quot;?><svg xmlns=&quot;http://www.w3.org/2000/svg&quot; viewBox=&quot;0 0 100 100&quot; shape-rendering=&quot;crispEdges&quot;><rect width=&quot;100&quot; height=&quot;100&quot; fill=&quot;white&quot;/><circle cx=&quot;50&quot; cy=&quot;50&quot; r=&quot;46&quot; fill=&quot;white&quot; stroke=&quot;black&quot; stroke-width=&quot;6&quot;/><circle cx=&quot;50&quot; cy=&quot;20&quot; r=&quot;3&quot; fill=&quot;black&quot;/><circle cx=&quot;80&quot; cy=&quot;50&quot; r=&quot;3&quot; fill=&quot;black&quot;/><circle cx=&quot;50&quot; cy=&quot;80&quot; r=&quot;3&quot; fill=&quot;black&quot;/><circle cx=&quot;20&quot; cy=&quot;50&quot; r=&quot;3&quot; fill=&quot;black&quot;/></svg>';" />
          <div class="hand hour"></div>
          <div class="hand minute"></div>
          <div class="hand second"></div>
        </div>

        <div class="word pixel">CKQUEST</div>
      </div>
      <div class="subtitle">Bora treinar como falar as horas em ingl√™s ‚Äî past / half / to ‚Äî de um jeito divertido. üéÆ</div>

      <div class="intro-panel">
        <div class="name-row">
          <label for="playerName" class="chip">Player name</label>
          <input id="playerName" type="text" placeholder="Ex.: Mr. Meia" />
          <button id="saveName" class="primary">Save</button>
        </div>

        <div class="mode-grid">
          <button class="card" id="goLearn"><b>Learn</b><br><span class="muted">Guided tutorial</span></button>
          <button class="card" id="goPractice"><b>Practice</b><br><span class="muted">Free practice</span></button>
          <button class="card" id="goChallenge"><b>Challenge</b><br><span class="muted">Race against time</span></button>
        </div>

        <div class="card" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <span class="chip">Level</span>
          <select id="levelIntro" class="pill">
            <option value="easy">Easy (180s in Challenge)</option>
            <option value="medium" selected>Medium (120s in Challenge)</option>
            <option value="hard">Hard (90s in Challenge)</option>
          </select>
          <span class="muted" style="color:#444">You can still change level inside the game.</span>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== GAME PAGE ===== -->
  <section id="game" style="display:none">
    <div class="grid">
      <div class="card">
        <canvas id="clock" class="clock" width="600" height="600" aria-label="Analog clock"></canvas>
        <div class="controls" style="margin-top:10px">
          <button id="btnNew" class="primary">Generate time</button>
          <button id="btnHint">Hint</button>
          <button id="btnShowNums">Show minute numbers</button>
          <button id="btnSetAsk">Ask to adjust hands</button>
        </div>
      </div>

      <div class="card">
        <div class="status" style="margin-bottom:10px">
          <span class="badge">Mode: <strong id="modeLabel">Practice</strong></span>
          <span class="badge">Level:
            <select id="level">
              <option value="easy">Easy</option>
              <option value="medium" selected>Medium</option>
              <option value="hard">Hard</option>
            </select>
          </span>
          <span class="badge">Score: <strong id="score">0</strong></span>
          <span class="badge">Time: <strong id="timer">‚Äî</strong></span>
          <span class="badge">Lives: <strong id="lives">3</strong> ‚ô•</span>
        </div>

        <div class="answer-zone" id="answerZone">
          <p id="prompt">Click ‚ÄúGenerate time‚Äù.</p>
          <div class="controls" style="margin-bottom:8px">
            <button id="btnMC" class="pill">Multiple choice</button>
            <button id="btnTyping" class="pill">Typing</button>
            <button id="btnDrag" class="pill">Drag hands</button>
          </div>
          <div id="mc" class="mc-grid" hidden></div>
          <div class="kbd-hint" id="kbdHint" hidden>
            Tip: press <span class="chip">A</span>, <span class="chip">B</span> or <span class="chip">C</span>
          </div>
          <div id="typing" hidden>
            <div class="controls">
              <input id="answer" type="text" placeholder='e.g., "a quarter past three" or "3:15"' />
              <button id="btnCheck" class="good">Check</button>
              <button id="btnSkip" class="bad">Skip</button>
            </div>
          </div>
          <div id="dragInfo" class="muted" style="color:#444" hidden></div>
          <div class="muted" id="hintArea" style="color:#444"></div>
          <div style="margin-top:8px"><div class="progress" aria-label="Skill progress"><span id="pbar"></span></div></div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3 style="margin:0 0 8px">Report</h3>
          <div id="report"></div>
        </div>

        <div id="challengePanel" class="card" style="margin-top:12px; display:none">
          <b>Challenge mode</b>
          <p style="margin:8px 0">When you‚Äôre ready, press <b>Start</b>. A countdown (3-2-1) will appear, then the timer begins.</p>
          <div class="controls">
            <button id="btnStartChallenge" class="primary">Start</button>
            <button id="btnBackHome">Back to Home</button>
          </div>
        </div>

        <div class="controls" style="margin-top:12px">
          <button id="btnHome">üè† Home</button>
        </div>
      </div>
    </div>
  </section>
</main>

<div id="overlay" class="overlay"><div class="count" id="countdown">3</div></div>

<footer>
  <small>¬© 2025 ClockQuest ‚Ä¢ Built for Maple Bear classrooms ‚Ä¢ <a href="#" id="how">How to publish on GitHub Pages</a></small>
</footer>

<script>
/* =============== Supabase SETUP =============== */
/* üëâ SUBSTITUA pelos dados do seu projeto */
const SB_URL = "https://YOUR-PROJECT.supabase.co";      // TODO
const SB_ANON= "YOUR-ANON-PUBLIC-KEY";                  // TODO
const supabase = window.supabase.createClient(SB_URL, SB_ANON);

async function sbEnsureAuth(){
  const { data: { user } } = await supabase.auth.getUser();
  if(!user){ await supabase.auth.signInAnonymously(); }
}
async function sbEnsurePlayer(displayName){
  await sbEnsureAuth();
  const { data: existing } = await supabase.from('players').select('id').eq('display_name', displayName).limit(1);
  if(existing && existing.length){ return existing[0].id; }
  const { data: inserted, error } = await supabase.from('players').insert({ display_name: displayName }).select('id').single();
  if(error){ console.error(error); return null; }
  return inserted.id;
}
async function saveHighscoreRemote({playerId, playerName, score, mode, level}){
  await sbEnsureAuth();
  const { error } = await supabase.from('scores').insert({ player_id:playerId, player_name:playerName, score, mode, level });
  if(error){ console.error("save score error:", error); }
}
async function loadLeaderboardRemote(limit=10){
  const { data, error } = await supabase.from('scores').select('player_name, score, level, created_at').order('score',{ascending:false}).limit(limit);
  if(error){ console.error(error); return []; }
  return data;
}
/* ============================================= */

/* ===== Helpers ===== */
const $ = s => document.querySelector(s);

/* ===== Player name & navigation ===== */
const nameInput = $("#playerName");
const saveNameBtn = $("#saveName");
const playerBadge = $("#playerBadge");
let PLAYER = localStorage.getItem("cq_name") || "";
let PLAYER_ID = null;

async function setPlayerName(n){
  PLAYER = (n||"").trim() || "Player";
  localStorage.setItem("cq_name", PLAYER);
  playerBadge.textContent = "üë§ " + PLAYER;
  playerBadge.hidden = false;
  PLAYER_ID = await sbEnsurePlayer(PLAYER);
}
if(PLAYER){ setPlayerName(PLAYER).then(()=>{ nameInput.value = PLAYER; }); }

saveNameBtn.addEventListener("click", async ()=>{
  await setPlayerName(nameInput.value);
  const t=saveNameBtn.textContent; saveNameBtn.textContent="Saved!"; setTimeout(()=>saveNameBtn.textContent=t,900);
});

/* ===== Intro ‚Üí Game ===== */
const levelIntro = $("#levelIntro");
let selectedMode = "practice";
$("#goLearn").addEventListener("click", ()=> enterGame("learn"));
$("#goPractice").addEventListener("click", ()=> enterGame("practice"));
$("#goChallenge").addEventListener("click", ()=> enterGame("challenge"));

function enterGame(mode){
  if(!PLAYER){ setPlayerName("Player"); }
  selectedMode = mode;
  $("#intro").style.display="none";
  $("#game").style.display="block";
  $("#modeLabel").textContent = mode[0].toUpperCase()+mode.slice(1);
  $("#level").value = levelIntro.value;
  $("#challengePanel").style.display = (mode==="challenge" ? "block" : "none");
  resetSession();
}

/* ===== O-clock (imagem) com ponteiros animados ===== */
(function(){
  const root = document.getElementById("logoO");
  if(!root) return;
  const h = root.querySelector(".hand.hour");
  const m = root.querySelector(".hand.minute");
  const s = root.querySelector(".hand.second");
  function tick(){
    const now=new Date();
    const hh=now.getHours()%12, mm=now.getMinutes(), ss=now.getSeconds();
    h.style.transform = `translate(-50%,-100%) rotate(${(hh+mm/60)*30}deg)`;
    m.style.transform = `translate(-50%,-100%) rotate(${(mm+ss/60)*6}deg)`;
    s.style.transform = `translate(-50%,-100%) rotate(${ss*6}deg)`;
  }
  tick(); setInterval(tick,1000);
})();

/* ===== Game drawing ===== */
const ctx = $("#clock").getContext("2d");
let showMinuteNums=false;
function drawClock(h=3,m=15){
  const c=$("#clock"); const w=c.width,hgt=c.height; const r=Math.min(w,hgt)/2-18;
  ctx.clearRect(0,0,w,hgt);
  ctx.save(); ctx.translate(w/2,hgt/2);
  ctx.fillStyle="#fff"; ctx.beginPath(); ctx.arc(0,0,r+10,0,Math.PI*2); ctx.fill();
  ctx.lineWidth=3; ctx.strokeStyle="#000"; ctx.stroke();
  for(let i=0;i<60;i++){
    const ang=i*Math.PI/30 - Math.PI/2;
    const len=(i%5===0)?14:6;
    ctx.beginPath();
    ctx.moveTo(Math.cos(ang)*(r-len), Math.sin(ang)*(r-len));
    ctx.lineTo(Math.cos(ang)*(r-2), Math.sin(ang)*(r-2));
    ctx.lineWidth=(i%5===0)?3:2; ctx.strokeStyle="#000"; ctx.stroke();
    if(showMinuteNums && i%5===0){
      ctx.fillStyle="#000"; ctx.font="14px system-ui";
      const label=(i===0?60:i);
      ctx.fillText(String(label), Math.cos(ang)*(r-34)-6, Math.sin(ang)*(r-34)+5);
    }
  }
  ctx.fillStyle="#000"; ctx.font="22px system-ui";
  for(let n=1;n<=12;n++){
    const ang=(n*Math.PI/6) - Math.PI/2;
    ctx.fillText(String(n), Math.cos(ang)*(r-52)-8, Math.sin(ang)*(r-52)+8);
  }
  const mh=(m/60)*Math.PI*2 - Math.PI/2;
  const hh=((h%12)/12 + m/720)*Math.PI*2 - Math.PI/2;
  ctx.strokeStyle="#000"; ctx.lineWidth=6; ctx.lineCap="round";
  ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(Math.cos(hh)*(r*0.5), Math.sin(hh)*(r*0.5)); ctx.stroke();
  ctx.strokeStyle="#c1121f"; ctx.lineWidth=5;
  ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(Math.cos(mh)*(r*0.75), Math.sin(mh)*(r*0.75)); ctx.stroke();
  ctx.fillStyle="#000"; ctx.beginPath(); ctx.arc(0,0,5,0,Math.PI*2); ctx.fill();
  ctx.restore();
}

/* Helpers & game logic */
function randInt(a,b){return Math.floor(Math.random()*(b-a+1))+a;}
function pad2(n){return (n<10?'0':'')+n;}
const words={1:"one",2:"two",3:"three",4:"four",5:"five",6:"six",7:"seven",8:"eight",9:"nine",10:"ten",11:"eleven",12:"twelve",13:"thirteen",14:"fourteen",15:"fifteen",16:"sixteen",17:"seventeen",18:"eighteen",19:"nineteen",20:"twenty",21:"twenty one",22:"twenty two",23:"twenty three",24:"twenty four",25:"twenty five",26:"twenty six",27:"twenty seven",28:"twenty eight",29:"twenty nine"};
function toEnglish(h,m){
  const h12=((h%12)||12), next=((h+1)%12)||12;
  if(m===0) return `${words[h12]} o‚Äôclock`;
  if(m===15) return `a quarter past ${words[h12]}`;
  if(m===30) return `half past ${words[h12]}`;
  if(m<30) return `${words[m]} past ${words[h12]}`;
  if(m===45) return `a quarter to ${words[next]}`;
  const remain=60-m; return `${words[remain]} to ${words[next]}`;
}
let target={h:3,m:15}, level="medium";
let score=0,lives=3,timer=null,seconds=0,attempt=0;
let dragMode=false,dragHand=null;
let currentShown={h:3,m:15};

function levelMinutes(){
  if(level==="easy") return [0,5,10,15,20,25,30,35,40,45,50,55].filter(x=>x<=40?true:[0,5,10,15,20,25,30].includes(x));
  if(level==="medium") return [0,5,10,15,20,25,30,35,40,45,50,55];
  return Array.from({length:60},(_,i)=>i);
}
function resetSession(){
  score=0; lives=3; attempt=0; seconds=0;
  $("#score").textContent=score; $("#lives").textContent=lives; $("#timer").textContent="‚Äî";
  $("#modeLabel").textContent = selectedMode[0].toUpperCase()+selectedMode.slice(1);
  $("#answerZone").classList.remove("stop");
  $("#report").innerHTML = renderHighscores();
  drawClock(target.h,target.m);
  if(selectedMode==="challenge"){ $("#timer").textContent="Ready"; }
}
function generateTime(){
  const mins=levelMinutes(); const m=mins[randInt(0,mins.length-1)];
  const h=randInt(1,12);
  target={h,m}; drawClock(h,m); attempt=0;
  $("#prompt").textContent="New time!"; $("#hintArea").textContent="";
  buildMC();
}
function englishAcceptList(h,m){
  const list=[toEnglish(h,m), `${((h%12)||12)}:${pad2(m)}`];
  if(m===0) list.push(`${((h%12)||12)} oclock`, `${((h%12)||12)} o‚Äôclock`);
  return list.map(s=>s.toLowerCase());
}
function checkTextAnswer(){
  const val=$("#answer").value.trim().toLowerCase();
  const en=englishAcceptList(target.h,target.m);
  attempt++;
  if(en.includes(val)){ onCorrect(); }
  else if(similar(val,en)){ flash("Almost! Check past/to and minutes."); }
  else{ onWrong(); }
}
function similar(val,list){ return list.some(x=>lev(val,x)<=2); }
function lev(a,b){ const m=[]; for(let i=0;i<=b.length;i++){m[i]=[i]} for(let j=0;j<=a.length;j++){m[0][j]=j}
  for(let i=1;i<=b.length;i++){for(let j=1;j<=a.length;j++){m[i][j]=Math.min(m[i-1][j]+1,m[i][j-1]+1,m[i-1][j-1]+(b[i-1]==a[j-1]?0:1))}}
  return m[b.length][a.length]; }
function onCorrect(){
  score+=10+(attempt===1?5:0);
  $("#score").textContent=score; flash("Correct! +10"); progress(10);
  $("#answerZone").classList.add("stop");
  if(selectedMode==="challenge") generateTime();
}
function onWrong(){
  if(++attempt>=3){ giveHint(); }
  lives--; $("#lives").textContent=lives; flash("Oops! Compare the hands.");
  if(selectedMode==="challenge" && lives<=0) endChallenge();
}
function progress(p){ const el=$("#pbar"); const cur=parseInt(el.style.width||"0"); el.style.width=Math.min(100,cur+p)+"%"; }
function flash(msg){ $("#prompt").textContent=msg; }

function buildMC(){
  const correct = toEnglish(target.h,target.m);
  const set=new Set([correct]);
  while(set.size<3){
    let h=randInt(1,12), m=(level==="hard")?randInt(0,59):[0,5,10,15,20,25,30,35,40,45,50,55][randInt(0,11)];
    set.add(toEnglish(h,m));
  }
  const opts=Array.from(set).sort(()=>Math.random()-0.5);
  const letters=["A","B","C"]; const mc=$("#mc"); mc.innerHTML=""; mc.hidden=false;
  $("#typing").hidden=true; $("#kbdHint").hidden=false; $("#answerZone").classList.remove("stop");
  opts.forEach((text,idx)=>{
    const btn=document.createElement("button");
    btn.className="choice"; btn.setAttribute("data-letter",letters[idx]);
    btn.setAttribute("data-correct", text===correct?"1":"0");
    btn.innerHTML=`<span class="badge-letter">${letters[idx]}</span><span>${text}</span>`;
    btn.addEventListener("click",()=> chooseMC(btn));
    mc.appendChild(btn);
  });
  window.onkeydown=(e)=>{ const k=e.key.toUpperCase(); const pos=letters.indexOf(k); if(pos>-1){ const btn=mc.children[pos]; if(btn) chooseMC(btn); } };
}
function chooseMC(btn){
  $("#answerZone").classList.add("stop");
  [...document.querySelectorAll(".choice")].forEach(b=>b.classList.remove("correct","wrong"));
  const correct=btn.getAttribute("data-correct")==="1";
  if(correct){ btn.classList.add("correct"); onCorrect(); } else { btn.classList.add("wrong"); onWrong(); }
}
function giveHint(){
  const m=target.m;
  $("#hintArea").textContent = (m<=30) ? 'Use ‚Äúpast‚Äù for 1‚Äì29 and ‚Äúhalf past‚Äù for :30.' : 'Use ‚Äúto‚Äù when minutes remain to next hour (31‚Äì59).';
}

/* Challenge timing + countdown */
function secondsForLevel(){ const v=$("#level").value; if(v==="easy") return 180; if(v==="medium") return 120; return 90; }
const overlay=$("#overlay"), countdown=$("#countdown");
$("#btnStartChallenge").addEventListener("click", ()=>{
  overlay.classList.add("show");
  let n=3; countdown.textContent=n;
  const iv=setInterval(()=>{ n--; if(n<=0){ clearInterval(iv); overlay.classList.remove("show"); startChallenge(); } else countdown.textContent=n; }, 800);
});
function startChallenge(){
  score=0; lives=3; seconds=secondsForLevel();
  $("#score").textContent=score; $("#lives").textContent=lives; $("#timer").textContent=seconds;
  if(timer){ clearInterval(timer); }
  timer=setInterval(()=>{ seconds--; $("#timer").textContent=seconds; if(seconds<=0) endChallenge(); },1000);
  generateTime();
}
async function endChallenge(){
  clearInterval(timer); timer=null;
  flash(`Report: ${score} pts`);
  saveHighscore(score); // local
  try{
    if(!PLAYER_ID){ PLAYER_ID = await sbEnsurePlayer(PLAYER||"Player"); }
    await saveHighscoreRemote({
      playerId: PLAYER_ID,
      playerName: PLAYER||"Player",
      score,
      mode: 'challenge',
      level: document.getElementById('level').value
    });
    const top = await loadLeaderboardRemote(5);
    const html = top.length
      ? "<ol>"+top.map(r=>`<li>${r.player_name}: <strong>${r.score}</strong> <small>(${r.level})</small></li>`).join("")+"</ol>"
      : "<em>No highscores yet.</em>";
    document.getElementById("report").innerHTML = html;
  }catch(e){ console.error(e); }
}

/* Local highscores (fallback) */
function saveHighscore(s){
  const key="cq_scores"; const arr=JSON.parse(localStorage.getItem(key)||"[]");
  const name=PLAYER||"Player"; arr.push({name,score:s,ts:Date.now()});
  arr.sort((a,b)=>b.score-a.score); localStorage.setItem(key, JSON.stringify(arr.slice(0,5)));
}
function renderHighscores(){
  const key="cq_scores"; const arr=JSON.parse(localStorage.getItem(key)||"[]");
  if(!arr.length) return "<em>No highscores yet.</em>";
  return "<ol>"+arr.map(x=>`<li>${x.name}: <strong>${x.score}</strong></li>`).join("")+"</ol>";
}

/* Drag minute hand (simple) */
$("#clock").addEventListener("mousedown", e=>{ if(!dragMode) return;
  const rect=e.target.getBoundingClientRect(); const x=e.clientX-rect.left-rect.width/2; const y=e.clientY-rect.top-rect.height/2;
  const a=Math.atan2(y,x); dragHand="minute"; setMinuteFromAngle(a);
});
$("#clock").addEventListener("mousemove", e=>{
  if(!dragMode||!dragHand) return;
  const rect=e.target.getBoundingClientRect(); const x=e.clientX-rect.left-rect.width/2; const y=e.clientY-rect.top-rect.height/2;
  const a=Math.atan2(y,x); setMinuteFromAngle(a);
});
window.addEventListener("mouseup", ()=> dragHand=null);
function setMinuteFromAngle(a){ let deg=a*180/Math.PI; deg=(deg+90+360)%360; const m=Math.round(deg/6)%60; currentShown.m=m; drawClock(currentShown.h,currentShown.m); }
function setHourFromTarget(){ currentShown.h=target.h; drawClock(currentShown.h,currentShown.m); }

/* Wiring */
$("#btnNew").addEventListener("click", generateTime);
$("#btnHint").addEventListener("click", giveHint);
$("#btnShowNums").addEventListener("click", ()=>{ showMinuteNums=!showMinuteNums; $("#btnShowNums").textContent = showMinuteNums ? "Hide minute numbers" : "Show minute numbers"; drawClock(target.h,target.m); });
$("#btnSetAsk").addEventListener("click", ()=>{ dragMode=true; $("#dragInfo").hidden=false; $("#dragInfo").textContent="Drag the hands to your answer, then press Check."; setHourFromTarget(); });
$("#btnMC").addEventListener("click", ()=>{ $("#mc").hidden=false; $("#typing").hidden=true; $("#kbdHint").hidden=false; });
$("#btnTyping").addEventListener("click", ()=>{ $("#mc").hidden=true; $("#typing").hidden=false; $("#kbdHint").hidden=true; $("#answer").focus(); $("#answerZone").classList.remove("stop"); });
$("#btnDrag").addEventListener("click", ()=>{ dragMode=true; $("#dragInfo").hidden=false; $("#dragInfo").textContent="Drag the hands to your answer, then press Check."; });

$("#btnCheck").addEventListener("click", checkTextAnswer);
$("#btnSkip").addEventListener("click", generateTime);
$("#answer").addEventListener("focus", ()=> $("#answerZone").classList.add("stop"));

$("#level").addEventListener("change", e=>{ level=e.target.value; });
$("#btnHome").addEventListener("click", ()=>{ $("#game").style.display="none"; $("#intro").style.display="grid"; });
$("#btnBackHome").addEventListener("click", ()=>{ $("#game").style.display="none"; $("#intro").style.display="grid"; });
document.getElementById("how").addEventListener("click",(e)=>{e.preventDefault(); alert("GitHub Pages: 1) Create a repo and push this index.html. 2) Settings ‚Üí Pages ‚Üí Source: 'Deploy from a branch', branch main, /. 3) Open the published link.");});

/* Init */
drawClock(3,15);
</script>
</body>
</html>
Mr. Meia is really proud of you guys!!!
